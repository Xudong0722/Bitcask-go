# Bitcask-go
KV-service with Golang


```
Memory:
        ---------
        | index | (BTree, ART)
        ---------
------------|-----------------------------------------------------------------------
Disk:       |
            |
            v
    ------------------
    |active data file|                                                          (key, seqNo)
    ------------------      +-----------+------------+------------+------------+------------+------------+
    |older data file |      |                                ...                                         |
    ------------------      +-----------+------------+------------+------------+------------+------------+  
    |older data file | -----|    crc    |    type    |  key size  | value size |   key data | value data |   
    ------------------      +-----------+------------+------------+------------+------------+------------+
    |    .....       |      |                                ...                                         |
    ------------------      +-----------+------------+------------+------------+------------+------------+
    |older data file |
    ------------------

```


## Merge 流程

1. 创建一个新的Merge-DB实例，将目前DB中所有的文件都认为是旧文件，创建一个新的活跃文件，这样我们就不会影响到DB的Put操作
2. 遍历所有的旧数据文件，对比每条数据的pos是否和index中的pos一致，若一致认为有效，添加到Merge-DB中，同时构造hint文件
3. 遍历完毕之后，写入一个标识Merge操作完成的文件，其中记录下最近的没有参与Merge的文件id，如此，我们会得到Merge-DB，存放了旧DB中所有旧数据文件精简后的数据，和一个hint文件，用于Merge-DB中所有数据加载索引时使用，Hint文件只维护了LogRecordPos，数据量更小，加载索引时更快